{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///Users/wearebrain/Desktop/Manglar%20Media/adv_builder/xevio-adv-builder/app/api/scrape/route.ts"],"sourcesContent":["import { NextResponse } from 'next/server'\nimport { createClient } from '@supabase/supabase-js'\n\nexport async function POST(request: Request) {\n  try {\n    const body = await request.json()\n    const { stepOneData, stepTwoData } = body\n\n    // 1. Validate data\n    if (!stepTwoData?.referenceUrls?.length || !stepTwoData.referenceUrls[0]) {\n      return NextResponse.json({ error: 'No reference URLs provided' }, { status: 400 })\n    }\n\n    // 2. Initialize Supabase client\n    // Note: In an API route, we could technically use the Service Role key if we needed to bypass RLS,\n    // but using the Anon key acts as a standard user. \n    // If you encounter permission issues, we might need the Service Role key here.\n    const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL!\n    const supabaseKey = process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!\n    const supabase = createClient(supabaseUrl, supabaseKey)\n\n    // 3. Create Campaign Record in Supabase\n    const { data: campaign, error: dbError } = await supabase\n      .from('campaigns')\n      .insert({\n        // Step 1 Data\n        topic: stepOneData.topic,\n        campaign_type: stepOneData.campaignType,\n        niche: stepOneData.niche,\n        country: stepOneData.country,\n        language: stepOneData.language,\n        length: stepOneData.length,\n        paragraph_length: stepOneData.paragraphLength,\n        guidelines: stepOneData.guidelines,\n\n        // Step 2 Data\n        reference_urls: stepTwoData.referenceUrls.filter((u: string) => u.trim() !== ''),\n        \n        status: 'scraping' // Initial status\n      })\n      .select()\n      .single()\n\n    if (dbError) {\n      console.error('Supabase Error:', dbError)\n      return NextResponse.json({ error: 'Failed to create campaign' }, { status: 500 })\n    }\n\n    // 4. Trigger n8n Webhook (Fire and forget - mostly)\n    // We don't await the full result, just the acknowledgement\n    // Replace this URL with your actual n8n webhook URL\n    const n8nWebhookUrl = process.env.N8N_SCRAPE_WEBHOOK_URL\n    const n8nWebhookSecret = process.env.N8N_WEBHOOK_SECRET\n    \n    if (n8nWebhookUrl) {\n      const headers: Record<string, string> = { 'Content-Type': 'application/json' }\n      if (n8nWebhookSecret) {\n        headers['X-Webhook-Secret'] = n8nWebhookSecret\n      }\n\n      // We don't await this fetch to prevent blocking, or we await it if it returns quickly.\n      // Usually webhooks return 200 OK immediately.\n      await fetch(n8nWebhookUrl, {\n        method: 'POST',\n        headers: headers,\n        body: JSON.stringify({\n          campaignId: campaign.id,\n          urls: campaign.reference_urls,\n          context: {\n            topic: stepOneData.topic,\n            niche: stepOneData.niche,\n            campaignType: stepOneData.campaignType,\n            country: stepOneData.country,\n            language: stepOneData.language,\n            guidelines: stepOneData.guidelines\n          }\n        })\n      })\n    } else {\n      console.warn('N8N_SCRAPE_WEBHOOK_URL is not defined')\n    }\n\n    return NextResponse.json({ success: true, campaignId: campaign.id })\n\n  } catch (error) {\n    console.error('API Error:', error)\n    return NextResponse.json({ error: 'Internal Server Error' }, { status: 500 })\n  }\n}\n\n"],"names":[],"mappings":";;;;AAAA;AACA;;;AAEO,eAAe,KAAK,OAAgB;IACzC,IAAI;QACF,MAAM,OAAO,MAAM,QAAQ,IAAI;QAC/B,MAAM,EAAE,WAAW,EAAE,WAAW,EAAE,GAAG;QAErC,mBAAmB;QACnB,IAAI,CAAC,aAAa,eAAe,UAAU,CAAC,YAAY,aAAa,CAAC,EAAE,EAAE;YACxE,OAAO,gJAAY,CAAC,IAAI,CAAC;gBAAE,OAAO;YAA6B,GAAG;gBAAE,QAAQ;YAAI;QAClF;QAEA,gCAAgC;QAChC,mGAAmG;QACnG,mDAAmD;QACnD,+EAA+E;QAC/E,MAAM;QACN,MAAM;QACN,MAAM,WAAW,IAAA,gMAAY,EAAC,aAAa;QAE3C,wCAAwC;QACxC,MAAM,EAAE,MAAM,QAAQ,EAAE,OAAO,OAAO,EAAE,GAAG,MAAM,SAC9C,IAAI,CAAC,aACL,MAAM,CAAC;YACN,cAAc;YACd,OAAO,YAAY,KAAK;YACxB,eAAe,YAAY,YAAY;YACvC,OAAO,YAAY,KAAK;YACxB,SAAS,YAAY,OAAO;YAC5B,UAAU,YAAY,QAAQ;YAC9B,QAAQ,YAAY,MAAM;YAC1B,kBAAkB,YAAY,eAAe;YAC7C,YAAY,YAAY,UAAU;YAElC,cAAc;YACd,gBAAgB,YAAY,aAAa,CAAC,MAAM,CAAC,CAAC,IAAc,EAAE,IAAI,OAAO;YAE7E,QAAQ,WAAW,iBAAiB;QACtC,GACC,MAAM,GACN,MAAM;QAET,IAAI,SAAS;YACX,QAAQ,KAAK,CAAC,mBAAmB;YACjC,OAAO,gJAAY,CAAC,IAAI,CAAC;gBAAE,OAAO;YAA4B,GAAG;gBAAE,QAAQ;YAAI;QACjF;QAEA,oDAAoD;QACpD,2DAA2D;QAC3D,oDAAoD;QACpD,MAAM,gBAAgB,QAAQ,GAAG,CAAC,sBAAsB;QACxD,MAAM,mBAAmB,QAAQ,GAAG,CAAC,kBAAkB;QAEvD,IAAI,eAAe;YACjB,MAAM,UAAkC;gBAAE,gBAAgB;YAAmB;YAC7E,IAAI,kBAAkB;gBACpB,OAAO,CAAC,mBAAmB,GAAG;YAChC;YAEA,uFAAuF;YACvF,8CAA8C;YAC9C,MAAM,MAAM,eAAe;gBACzB,QAAQ;gBACR,SAAS;gBACT,MAAM,KAAK,SAAS,CAAC;oBACnB,YAAY,SAAS,EAAE;oBACvB,MAAM,SAAS,cAAc;oBAC7B,SAAS;wBACP,OAAO,YAAY,KAAK;wBACxB,OAAO,YAAY,KAAK;wBACxB,cAAc,YAAY,YAAY;wBACtC,SAAS,YAAY,OAAO;wBAC5B,UAAU,YAAY,QAAQ;wBAC9B,YAAY,YAAY,UAAU;oBACpC;gBACF;YACF;QACF,OAAO;YACL,QAAQ,IAAI,CAAC;QACf;QAEA,OAAO,gJAAY,CAAC,IAAI,CAAC;YAAE,SAAS;YAAM,YAAY,SAAS,EAAE;QAAC;IAEpE,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,cAAc;QAC5B,OAAO,gJAAY,CAAC,IAAI,CAAC;YAAE,OAAO;QAAwB,GAAG;YAAE,QAAQ;QAAI;IAC7E;AACF"}}]
}