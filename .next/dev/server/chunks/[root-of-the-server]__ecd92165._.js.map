{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///Users/wearebrain/Desktop/Manglar%20Media/adv_builder/xevio-adv-builder/lib/url-utils.ts"],"sourcesContent":["import { ReferenceUrl } from './types'\n\nexport type UrlChangeType = 'none' | 'additions_only' | 'structural'\n\nexport interface UrlChangeResult {\n  changeType: UrlChangeType\n  newUrls: string[]\n}\n\n/**\n * Normalize a URL for comparison by trimming whitespace and removing trailing slashes\n */\nfunction normalizeUrl(url: string): string {\n  return url.trim().replace(/\\/+$/, '').toLowerCase()\n}\n\n/**\n * Clean a URL for storage and sending: trim whitespace and strip trailing slashes.\n * Unlike normalizeUrl, this preserves the original casing (paths can be case-sensitive).\n */\nexport function cleanUrl(url: string): string {\n  return url.trim().replace(/\\/+$/, '')\n}\n\n/**\n * Extract URL strings from ReferenceUrl array\n */\nexport function extractUrls(referenceUrls: ReferenceUrl[]): string[] {\n  return referenceUrls\n    .map(ref => typeof ref === 'string' ? ref : ref?.url)\n    .filter((url): url is string => !!url && url.trim() !== '')\n    .map(normalizeUrl)\n}\n\n/**\n * Detect what type of URL changes occurred between current and scraped URLs\n * \n * @param currentUrls - Array of current URLs entered by user\n * @param scrapedUrls - Array of URLs that were previously scraped\n * @returns Object with changeType and array of new URLs (for additions_only case)\n * \n * Logic:\n * - 'none': Sets are identical, no changes needed\n * - 'additions_only': Current is a superset of scraped (only new URLs added)\n * - 'structural': URLs were deleted or modified, requires full re-scrape\n */\nexport function detectUrlChanges(\n  currentUrls: string[],\n  scrapedUrls: string[]\n): UrlChangeResult {\n  // Normalize all URLs for comparison\n  const currentSet = new Set(currentUrls.map(normalizeUrl))\n  const scrapedSet = new Set(scrapedUrls.map(normalizeUrl))\n\n  // If both are empty or identical, no changes\n  if (currentSet.size === 0 && scrapedSet.size === 0) {\n    return { changeType: 'none', newUrls: [] }\n  }\n\n  // Check if sets are identical\n  if (currentSet.size === scrapedSet.size) {\n    const allMatch = [...currentSet].every(url => scrapedSet.has(url))\n    if (allMatch) {\n      return { changeType: 'none', newUrls: [] }\n    }\n  }\n\n  // Check if all scraped URLs still exist in current (additions only)\n  const allScrapedStillExist = [...scrapedSet].every(url => currentSet.has(url))\n  \n  if (allScrapedStillExist) {\n    // Find new URLs (in current but not in scraped)\n    const newUrls = [...currentSet].filter(url => !scrapedSet.has(url))\n    \n    if (newUrls.length > 0) {\n      return { changeType: 'additions_only', newUrls }\n    }\n    \n    // No new URLs and all scraped exist = no changes\n    return { changeType: 'none', newUrls: [] }\n  }\n\n  // Some scraped URLs were removed or modified = structural change\n  return { changeType: 'structural', newUrls: [] }\n}\n\n/**\n * Compare two StepOneState objects to detect if there are meaningful changes\n * that would affect scraping (context-related fields)\n */\nexport function hasStepOneChanges(\n  current: { topic: string; niche: string; campaignType: string; country: string; language: string; guidelines: string },\n  original: { topic: string; niche: string; campaignType: string; country: string; language: string; guidelines: string } | null | undefined\n): boolean {\n  if (!original) return false\n  \n  // Compare fields that affect scraping context\n  return (\n    current.topic !== original.topic ||\n    current.niche !== original.niche ||\n    current.campaignType !== original.campaignType ||\n    current.country !== original.country ||\n    current.language !== original.language ||\n    current.guidelines !== original.guidelines\n  )\n}\n"],"names":[],"mappings":";;;;;;;;;;AASA;;CAEC,GACD,SAAS,aAAa,GAAW;IAC/B,OAAO,IAAI,IAAI,GAAG,OAAO,CAAC,QAAQ,IAAI,WAAW;AACnD;AAMO,SAAS,SAAS,GAAW;IAClC,OAAO,IAAI,IAAI,GAAG,OAAO,CAAC,QAAQ;AACpC;AAKO,SAAS,YAAY,aAA6B;IACvD,OAAO,cACJ,GAAG,CAAC,CAAA,MAAO,OAAO,QAAQ,WAAW,MAAM,KAAK,KAChD,MAAM,CAAC,CAAC,MAAuB,CAAC,CAAC,OAAO,IAAI,IAAI,OAAO,IACvD,GAAG,CAAC;AACT;AAcO,SAAS,iBACd,WAAqB,EACrB,WAAqB;IAErB,oCAAoC;IACpC,MAAM,aAAa,IAAI,IAAI,YAAY,GAAG,CAAC;IAC3C,MAAM,aAAa,IAAI,IAAI,YAAY,GAAG,CAAC;IAE3C,6CAA6C;IAC7C,IAAI,WAAW,IAAI,KAAK,KAAK,WAAW,IAAI,KAAK,GAAG;QAClD,OAAO;YAAE,YAAY;YAAQ,SAAS,EAAE;QAAC;IAC3C;IAEA,8BAA8B;IAC9B,IAAI,WAAW,IAAI,KAAK,WAAW,IAAI,EAAE;QACvC,MAAM,WAAW;eAAI;SAAW,CAAC,KAAK,CAAC,CAAA,MAAO,WAAW,GAAG,CAAC;QAC7D,IAAI,UAAU;YACZ,OAAO;gBAAE,YAAY;gBAAQ,SAAS,EAAE;YAAC;QAC3C;IACF;IAEA,oEAAoE;IACpE,MAAM,uBAAuB;WAAI;KAAW,CAAC,KAAK,CAAC,CAAA,MAAO,WAAW,GAAG,CAAC;IAEzE,IAAI,sBAAsB;QACxB,gDAAgD;QAChD,MAAM,UAAU;eAAI;SAAW,CAAC,MAAM,CAAC,CAAA,MAAO,CAAC,WAAW,GAAG,CAAC;QAE9D,IAAI,QAAQ,MAAM,GAAG,GAAG;YACtB,OAAO;gBAAE,YAAY;gBAAkB;YAAQ;QACjD;QAEA,iDAAiD;QACjD,OAAO;YAAE,YAAY;YAAQ,SAAS,EAAE;QAAC;IAC3C;IAEA,iEAAiE;IACjE,OAAO;QAAE,YAAY;QAAc,SAAS,EAAE;IAAC;AACjD;AAMO,SAAS,kBACd,OAAsH,EACtH,QAA0I;IAE1I,IAAI,CAAC,UAAU,OAAO;IAEtB,8CAA8C;IAC9C,OACE,QAAQ,KAAK,KAAK,SAAS,KAAK,IAChC,QAAQ,KAAK,KAAK,SAAS,KAAK,IAChC,QAAQ,YAAY,KAAK,SAAS,YAAY,IAC9C,QAAQ,OAAO,KAAK,SAAS,OAAO,IACpC,QAAQ,QAAQ,KAAK,SAAS,QAAQ,IACtC,QAAQ,UAAU,KAAK,SAAS,UAAU;AAE9C"}},
    {"offset": {"line": 126, "column": 0}, "map": {"version":3,"sources":["file:///Users/wearebrain/Desktop/Manglar%20Media/adv_builder/xevio-adv-builder/app/api/lazy-generate/route.ts"],"sourcesContent":["import { NextResponse } from 'next/server'\nimport { createClient } from '@supabase/supabase-js'\nimport { cleanUrl } from '@/lib/url-utils'\n\nexport async function POST(request: Request) {\n  try {\n    const body = await request.json()\n    const { lazyModeData, userId } = body\n\n    if (!lazyModeData || !userId) {\n      return NextResponse.json({ error: 'Missing required data' }, { status: 400 })\n    }\n\n    const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL!\n    const supabaseKey = process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!\n    const supabase = createClient(supabaseUrl, supabaseKey)\n\n    const advertorialUrl = cleanUrl(lazyModeData.advertorialUrl || '')\n    if (!advertorialUrl) {\n      return NextResponse.json({ error: 'Advertorial URL is required' }, { status: 400 })\n    }\n\n    const additionalLinks = (lazyModeData.referenceUrls || [])\n      .filter((ref: any) => ref?.url && ref.url.trim() !== '')\n      .map((ref: any) => ({\n        url: cleanUrl(ref.url),\n        description: ref.description?.trim() || null,\n      }))\n\n    const referenceUrls = [\n      { url: advertorialUrl, description: 'Reference advertorial' },\n      ...additionalLinks,\n    ]\n\n    const lengthValue = lazyModeData.keepOriginalLength ? 'keep_original' : lazyModeData.length\n\n    // Create campaign record\n    const { data: campaign, error: dbError } = await supabase\n      .from('campaigns')\n      .insert({\n        user_id: userId,\n        mode: 'lazy',\n        topic: lazyModeData.instructions,\n        campaign_type: lazyModeData.campaignType,\n        niche: lazyModeData.niche,\n        country: lazyModeData.country,\n        language: lazyModeData.language,\n        length: lengthValue,\n        paragraph_length: lazyModeData.paragraphLength,\n        guidelines: lazyModeData.guidelines,\n        reference_urls: referenceUrls,\n        status: 'generating',\n      })\n      .select()\n      .single()\n\n    if (dbError) {\n      console.error('Supabase Error:', dbError)\n      return NextResponse.json({ error: 'Failed to create campaign' }, { status: 500 })\n    }\n\n    // Trigger n8n webhook\n    const webhookUrl = process.env.N8N_LAZY_MODE_WEBHOOK_URL\n    const webhookSecret = process.env.N8N_WEBHOOK_SECRET\n\n    if (webhookUrl) {\n      const headers: Record<string, string> = { 'Content-Type': 'application/json' }\n      if (webhookSecret) {\n        headers['X-Webhook-Secret'] = webhookSecret\n      }\n\n      const webhookPayload = {\n        campaignId: campaign.id,\n        instructions: lazyModeData.instructions,\n        advertorialUrl,\n        additionalLinks,\n        referenceUrls,\n        campaignType: lazyModeData.campaignType,\n        niche: lazyModeData.niche,\n        country: lazyModeData.country,\n        language: lazyModeData.language,\n        length: lengthValue,\n        paragraphLength: lazyModeData.paragraphLength,\n        guidelines: lazyModeData.guidelines,\n        customGuidelines: lazyModeData.customGuidelines || null,\n      }\n\n      fetch(webhookUrl, {\n        method: 'POST',\n        headers,\n        body: JSON.stringify(webhookPayload),\n      }).catch((error) => {\n        console.error('Failed to trigger n8n lazy mode webhook:', error)\n      })\n    } else {\n      console.warn('N8N_LAZY_MODE_WEBHOOK_URL is not defined')\n    }\n\n    return NextResponse.json({ success: true, campaignId: campaign.id })\n  } catch (error) {\n    console.error('API Error:', error)\n    return NextResponse.json({ error: 'Internal Server Error' }, { status: 500 })\n  }\n}\n"],"names":[],"mappings":";;;;AAAA;AACA;AACA;;;;AAEO,eAAe,KAAK,OAAgB;IACzC,IAAI;QACF,MAAM,OAAO,MAAM,QAAQ,IAAI;QAC/B,MAAM,EAAE,YAAY,EAAE,MAAM,EAAE,GAAG;QAEjC,IAAI,CAAC,gBAAgB,CAAC,QAAQ;YAC5B,OAAO,gJAAY,CAAC,IAAI,CAAC;gBAAE,OAAO;YAAwB,GAAG;gBAAE,QAAQ;YAAI;QAC7E;QAEA,MAAM;QACN,MAAM;QACN,MAAM,WAAW,IAAA,gMAAY,EAAC,aAAa;QAE3C,MAAM,iBAAiB,IAAA,iIAAQ,EAAC,aAAa,cAAc,IAAI;QAC/D,IAAI,CAAC,gBAAgB;YACnB,OAAO,gJAAY,CAAC,IAAI,CAAC;gBAAE,OAAO;YAA8B,GAAG;gBAAE,QAAQ;YAAI;QACnF;QAEA,MAAM,kBAAkB,CAAC,aAAa,aAAa,IAAI,EAAE,EACtD,MAAM,CAAC,CAAC,MAAa,KAAK,OAAO,IAAI,GAAG,CAAC,IAAI,OAAO,IACpD,GAAG,CAAC,CAAC,MAAa,CAAC;gBAClB,KAAK,uIAAS,IAAI,GAAG;gBACrB,aAAa,IAAI,WAAW,EAAE,UAAU;YAC1C,CAAC;QAEH,MAAM,gBAAgB;YACpB;gBAAE,KAAK;gBAAgB,aAAa;YAAwB;eACzD;SACJ;QAED,MAAM,cAAc,aAAa,kBAAkB,GAAG,kBAAkB,aAAa,MAAM;QAE3F,yBAAyB;QACzB,MAAM,EAAE,MAAM,QAAQ,EAAE,OAAO,OAAO,EAAE,GAAG,MAAM,SAC9C,IAAI,CAAC,aACL,MAAM,CAAC;YACN,SAAS;YACT,MAAM;YACN,OAAO,aAAa,YAAY;YAChC,eAAe,aAAa,YAAY;YACxC,OAAO,aAAa,KAAK;YACzB,SAAS,aAAa,OAAO;YAC7B,UAAU,aAAa,QAAQ;YAC/B,QAAQ;YACR,kBAAkB,aAAa,eAAe;YAC9C,YAAY,aAAa,UAAU;YACnC,gBAAgB;YAChB,QAAQ;QACV,GACC,MAAM,GACN,MAAM;QAET,IAAI,SAAS;YACX,QAAQ,KAAK,CAAC,mBAAmB;YACjC,OAAO,gJAAY,CAAC,IAAI,CAAC;gBAAE,OAAO;YAA4B,GAAG;gBAAE,QAAQ;YAAI;QACjF;QAEA,sBAAsB;QACtB,MAAM,aAAa,QAAQ,GAAG,CAAC,yBAAyB;QACxD,MAAM,gBAAgB,QAAQ,GAAG,CAAC,kBAAkB;QAEpD,IAAI,YAAY;YACd,MAAM,UAAkC;gBAAE,gBAAgB;YAAmB;YAC7E,IAAI,eAAe;gBACjB,OAAO,CAAC,mBAAmB,GAAG;YAChC;YAEA,MAAM,iBAAiB;gBACrB,YAAY,SAAS,EAAE;gBACvB,cAAc,aAAa,YAAY;gBACvC;gBACA;gBACA;gBACA,cAAc,aAAa,YAAY;gBACvC,OAAO,aAAa,KAAK;gBACzB,SAAS,aAAa,OAAO;gBAC7B,UAAU,aAAa,QAAQ;gBAC/B,QAAQ;gBACR,iBAAiB,aAAa,eAAe;gBAC7C,YAAY,aAAa,UAAU;gBACnC,kBAAkB,aAAa,gBAAgB,IAAI;YACrD;YAEA,MAAM,YAAY;gBAChB,QAAQ;gBACR;gBACA,MAAM,KAAK,SAAS,CAAC;YACvB,GAAG,KAAK,CAAC,CAAC;gBACR,QAAQ,KAAK,CAAC,4CAA4C;YAC5D;QACF,OAAO;YACL,QAAQ,IAAI,CAAC;QACf;QAEA,OAAO,gJAAY,CAAC,IAAI,CAAC;YAAE,SAAS;YAAM,YAAY,SAAS,EAAE;QAAC;IACpE,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,cAAc;QAC5B,OAAO,gJAAY,CAAC,IAAI,CAAC;YAAE,OAAO;QAAwB,GAAG;YAAE,QAAQ;QAAI;IAC7E;AACF"}}]
}