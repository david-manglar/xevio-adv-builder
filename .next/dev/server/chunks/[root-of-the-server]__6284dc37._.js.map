{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///Users/wearebrain/Desktop/Manglar%20Media/adv_builder/xevio-adv-builder/app/api/generate/route.ts"],"sourcesContent":["import { NextResponse } from 'next/server'\nimport { createClient } from '@supabase/supabase-js'\n\nexport async function POST(request: Request) {\n  try {\n    const body = await request.json()\n    const { campaignId, stepOneData, stepTwoData, stepThreeData, stepFourData, stepFiveData } = body\n\n    if (!campaignId) {\n      return NextResponse.json({ error: 'Campaign ID is required' }, { status: 400 })\n    }\n\n    const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL!\n    const supabaseKey = process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!\n    const supabase = createClient(supabaseUrl, supabaseKey)\n\n    // 1. Update campaign status to 'generating'\n    const { error: updateError } = await supabase\n      .from('campaigns')\n      .update({ status: 'generating' })\n      .eq('id', campaignId)\n\n    if (updateError) {\n      console.error('Supabase Error:', updateError)\n      return NextResponse.json({ error: 'Failed to update campaign status' }, { status: 500 })\n    }\n\n    // 2. Build clean payload with final/edited values from Step 5\n    const finalSettings = stepFiveData?.campaignData || {}\n    \n    // Extract only selected insights from Step 3\n    const selectedInsights: Record<string, string[]> = {}\n    if (stepThreeData?.data) {\n      for (const [category, items] of Object.entries(stepThreeData.data)) {\n        const selected = (items as any[])\n          .filter((item: any) => item.selected)\n          .map((item: any) => item.text)\n        if (selected.length > 0) {\n          selectedInsights[category] = selected\n        }\n      }\n    }\n\n    // Build structure blocks with their inputs (position is 1-indexed for clarity)\n    const structureBlocks = (stepFourData?.blocks || []).map((block: any, index: number) => ({\n      position: index + 1,\n      name: block.name,\n      inputValue: block.inputValue || null,\n      selectValue: block.selectValue || null,\n    }))\n\n    // Clean payload for n8n\n    const webhookPayload = {\n      campaignId,\n      \n      // Final campaign settings (edited in Step 5, or original from Step 1)\n      topic: stepFiveData?.topic || stepOneData?.topic,\n      campaignType: finalSettings.campaignType || stepOneData?.campaignType,\n      niche: finalSettings.niche || stepOneData?.niche,\n      country: finalSettings.country || stepOneData?.country,\n      language: finalSettings.language || stepOneData?.language,\n      length: finalSettings.length || stepOneData?.length,\n      paragraphLength: finalSettings.paragraphLength || stepOneData?.paragraphLength,\n      guidelines: finalSettings.guidelines || stepOneData?.guidelines,\n\n      // Reference URLs from Step 2\n      referenceUrls: (stepTwoData?.referenceUrls || []).filter((url: string) => url.trim() !== ''),\n\n      // Only selected insights from Step 3\n      selectedInsights,\n\n      // Ordered structure blocks from Step 4\n      structureBlocks,\n    }\n\n    // 3. Trigger n8n webhook\n    const webhookUrl = process.env.N8N_GENERATE_WEBHOOK_URL\n    const webhookSecret = process.env.N8N_WEBHOOK_SECRET\n\n    if (!webhookUrl) {\n      console.warn('N8N_GENERATE_WEBHOOK_URL not set')\n    } else {\n      try {\n        const headers: Record<string, string> = { 'Content-Type': 'application/json' }\n        if (webhookSecret) {\n          headers['X-Webhook-Secret'] = webhookSecret\n        }\n\n        console.log('Calling n8n generate webhook:', webhookUrl)\n        \n        const response = await fetch(webhookUrl, {\n          method: 'POST',\n          headers,\n          body: JSON.stringify(webhookPayload)\n        })\n\n        console.log('n8n webhook response status:', response.status)\n        \n        if (!response.ok) {\n          console.error('n8n webhook returned error:', response.status, await response.text())\n        }\n      } catch (webhookError) {\n        console.error('Webhook Error:', webhookError)\n      }\n    }\n\n    return NextResponse.json({ success: true })\n\n  } catch (error) {\n    console.error('API Error:', error)\n    return NextResponse.json({ error: 'Internal Server Error' }, { status: 500 })\n  }\n}\n\n"],"names":[],"mappings":"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"}}]
}